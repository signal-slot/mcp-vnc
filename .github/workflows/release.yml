name: Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            name: linux-x64
          - os: macos-14
            name: macos-arm64
          - os: windows-latest
            name: windows-x64
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ninja-build pkg-config \
            libgl-dev libxcb1-dev libxcb-glx0-dev libxcb-keysyms1-dev \
            libxcb-image0-dev libxcb-shm0-dev libxcb-icccm4-dev libxcb-sync-dev \
            libxcb-xfixes0-dev libxcb-shape0-dev libxcb-randr0-dev libxcb-render-util0-dev \
            libxcb-cursor-dev libxcb-xinerama0-dev libxcb-xkb-dev \
            libxkbcommon-dev libxkbcommon-x11-dev libfontconfig1-dev libfreetype6-dev \
            libglib2.0-dev zlib1g-dev \
            libavcodec-dev libavformat-dev libavutil-dev libswresample-dev libswscale-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install ninja

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: choco install ninja

      - name: Cache static Qt
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ runner.os == 'Windows' && 'C:/qt-static' || '~/qt-static' }}
          key: qt-static-6.8.2-${{ matrix.os }}-v4

      - name: Download Qt source
        if: steps.cache-qt.outputs.cache-hit != 'true'
        shell: bash
        run: |
          curl -L -o qtbase.tar.xz \
            https://download.qt.io/official_releases/qt/6.8/6.8.2/submodules/qtbase-everywhere-src-6.8.2.tar.xz
          tar xf qtbase.tar.xz
          curl -L -o qtmultimedia.tar.xz \
            https://download.qt.io/official_releases/qt/6.8/6.8.2/submodules/qtmultimedia-everywhere-src-6.8.2.tar.xz
          tar xf qtmultimedia.tar.xz

      - name: Build static Qt (Linux)
        if: steps.cache-qt.outputs.cache-hit != 'true' && runner.os == 'Linux'
        run: |
          cd qtbase-everywhere-src-6.8.2
          ./configure -static -release -prefix $HOME/qt-static \
            -nomake tests -nomake examples -xcb \
            -- -DFEATURE_cxx20=ON
          cmake --build . --parallel $(nproc)
          cmake --install .

      - name: Build static Qt Multimedia (Linux)
        if: steps.cache-qt.outputs.cache-hit != 'true' && runner.os == 'Linux'
        run: |
          cd qtmultimedia-everywhere-src-6.8.2
          $HOME/qt-static/bin/qt-configure-module .
          cmake --build . --parallel $(nproc)
          cmake --install .

      - name: Build static Qt (macOS)
        if: steps.cache-qt.outputs.cache-hit != 'true' && runner.os == 'macOS'
        run: |
          cd qtbase-everywhere-src-6.8.2
          ./configure -static -release -prefix $HOME/qt-static \
            -nomake tests -nomake examples \
            -- -DCMAKE_OSX_ARCHITECTURES=arm64 -DFEATURE_cxx20=ON
          cmake --build . --parallel $(sysctl -n hw.ncpu)
          cmake --install .

      - name: Build static Qt Multimedia (macOS)
        if: steps.cache-qt.outputs.cache-hit != 'true' && runner.os == 'macOS'
        run: |
          cd qtmultimedia-everywhere-src-6.8.2
          $HOME/qt-static/bin/qt-configure-module . -- \
            -DFEATURE_ffmpeg=OFF -DCMAKE_OSX_ARCHITECTURES=arm64
          cmake --build . --parallel $(sysctl -n hw.ncpu)
          cmake --install .

      - name: Build static Qt (Windows)
        if: steps.cache-qt.outputs.cache-hit != 'true' && runner.os == 'Windows'
        shell: cmd
        run: |
          cd qtbase-everywhere-src-6.8.2
          CALL configure.bat -static -release -prefix C:\qt-static -nomake tests -nomake examples -- -DFEATURE_cxx20=ON
          cmake --build . --parallel
          cmake --install .

      - name: Build static Qt Multimedia (Windows)
        if: steps.cache-qt.outputs.cache-hit != 'true' && runner.os == 'Windows'
        shell: cmd
        run: |
          cd qtmultimedia-everywhere-src-6.8.2
          C:\qt-static\bin\qt-configure-module . -- -DFEATURE_ffmpeg=OFF
          cmake --build . --parallel
          cmake --install .

      - name: Align submodule Qt versions
        shell: bash
        run: |
          QT_VER=6.8.2
          if [ "$RUNNER_OS" = "macOS" ]; then
            sed -i '' "s/QT_REPO_MODULE_VERSION \"[^\"]*\"/QT_REPO_MODULE_VERSION \"${QT_VER}\"/" \
              3rdparty/qtmcp/.cmake.conf 3rdparty/qtvncclient/.cmake.conf
          else
            sed -i "s/QT_REPO_MODULE_VERSION \"[^\"]*\"/QT_REPO_MODULE_VERSION \"${QT_VER}\"/" \
              3rdparty/qtmcp/.cmake.conf 3rdparty/qtvncclient/.cmake.conf
          fi

      - name: Build
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            export PATH="/c/qt-static/bin:$PATH"
            PREFIX_PATH="C:/qt-static"
          else
            export PATH="$HOME/qt-static/bin:$PATH"
            PREFIX_PATH="$HOME/qt-static"
          fi
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="$PREFIX_PATH" -G Ninja
          cmake --build build

      - name: Prepare artifact
        shell: bash
        run: |
          mkdir -p dist
          if [ "$RUNNER_OS" = "Windows" ]; then
            cp build/mcp-vnc.exe "dist/mcp-vnc-${{ matrix.name }}.exe"
          else
            cp build/mcp-vnc "dist/mcp-vnc-${{ matrix.name }}"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mcp-vnc-${{ matrix.name }}
          path: dist/mcp-vnc-*

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/mcp-vnc-*
